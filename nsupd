#!/bin/sh
############################################################ IDENT(1)
#
# $Title: Script to make dynamic changes to nsadmin $
# $Copyright: 2019 Devin Teske. All rights reserved. $
# $FrauBSD: nsadmin/nsupd 2019-11-01 16:16:37 -0700 freebsdfrau $
#
############################################################ CONFIGURATION

DEFAULT_TIMEOUT=300

############################################################ GLOBALS

VERSION='$Version: 0.0.7 $'

pgm="${0##*/}" # Program basename

PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin

#
# Global exit status
#
SUCCESS=0
FAILURE=1

#
# OS Glue
#
: ${UNAME_s:=$( uname -s )}

#
# Command-line options
#
INTERACTIVE=1			# -i
LOCAL=				# -l
TIMEOUT=$DEFAULT_TIMEOUT	# -t timeout

############################################################ FUNCTIONS

die()
{
	local fmt="$1"
	if [ $# -gt 0 ]; then
		shift 1 # fmt
		printf "%s: $fmt\n" "$pgm" "$@" >&2
	fi
	exit $FAILURE
}

usage()
{
	local optfmt="\t%-16s %s\n"
	exec >&2
	if [ $# -gt 0 ]; then
		local fmt="$1"
		shift 1 # fmt
		printf "%s: $fmt\n" "$pgm" "$@"
	fi
	printf "Usage: %s [-hlV] [ignored]\n" "$pgm"
	printf "Options:\n"
	printf "$optfmt" "-i" "Force interactive mode."
	printf "$optfmt" "-h" "Print usage statement and exit."
	printf "$optfmt" "-l" "Local-host only mode."
	printf "$optfmt" "-t timeout" \
		"Update timeout in seconds. Default $DEFAULT_TIMEOUT."
	printf "$optfmt" "-V" "Print version and exit."
	printf "Ignored Options (for compatibility):\n"
	printf "$optfmt" "-d" "Not implemented."
	printf "$optfmt" "-D" "Not implemented."
	printf "$optfmt" "-g" "Not implemented."
	printf "$optfmt" "-k keyfile" "Not implemented."
	printf "$optfmt" "-L level" "Not implemented."
	printf "$optfmt" "-p port" "Not implemented."
	printf "$optfmt" "-P" "Not implemented. Silently exits."
	printf "$optfmt" "-r udpretries" "Not implemented."
	printf "$optfmt" "-R randomdev" "Not implemented."
	printf "$optfmt" "-T" "Not implemented. Silently exits."
	printf "$optfmt" "-u udptimeout" "Not implemented."
	printf "$optfmt" "-v" "Not implemented."
	printf "$optfmt" "-y [hmac:]keyname:secret" ""
	printf "$optfmt" "" "Not implemented."
	die
}

############################################################ MAIN

[ -t 1 ] || INTERACTIVE= # stdin is not a TTY

#
# Process command-line options
#
optign=dDgk:L:p:r:R:u:vy:
optignx=PT
while getopts ihlt:V$optign$optignx flag; do
	case "$flag" in
	d|D|g|k|L|p|r|R|u|v|y) : ignored ;;
	P|T) exit $SUCCESS ;; # Not implemented
	i) INTERACTIVE=1 ;;
	l) LOCAL=1 ;;
	t) TIMEOUT="$OPTARG" ;;
	V) VERSION="${VERSION#*: }"
		echo "${VERSION% $}"
		exit $SUCCESS ;;
	*) usage # NOTREACHED
	esac
done
shift $(( $OPTIND - 1 ))

#
# Validate command-line options
#
case "$TIMEOUT" in
""|*[!0-9]*)
	usage "\`-t timeout' requires a numerical argument"
	;; # NOTREACHED
esac

#
# XXX TODO XXX
#

exit $SUCCESS

################################################################################
# END
################################################################################
